<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>ƒêi·ªÅu Khi·ªÉn LED T·ª´ Xa - IoT Control</title>
    
    <!-- MQTT Library -->
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary-color: #2196F3;
            --success-color: #4CAF50;
            --danger-color: #f44336;
            --warning-color: #ff9800;
            --dark-color: #333;
            --light-color: #f4f4f4;
        }
        
        body {
            font-family: 'Roboto', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--dark-color);
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        /* Header */
        .header {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .header h1 {
            font-size: 32px;
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        
        .header p {
            color: #666;
            font-size: 16px;
        }
        
        /* Connection Status */
        .connection-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .status-item {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .status-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        
        .status-info h3 {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .status-info p {
            font-size: 18px;
            font-weight: 500;
        }
        
        .connected .status-icon {
            background: #d4edda;
            color: #155724;
        }
        
        .disconnected .status-icon {
            background: #f8d7da;
            color: #721c24;
        }
        
        /* Device Selection */
        .device-section {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        
        .device-selector {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .device-btn {
            flex: 1;
            min-width: 200px;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
        }
        
        .device-btn.active {
            border-color: var(--primary-color);
            background: #e3f2fd;
        }
        
        .device-btn .device-name {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 5px;
        }
        
        .device-btn .device-id {
            font-size: 12px;
            color: #666;
        }
        
        .device-btn .device-status {
            font-size: 12px;
            margin-top: 5px;
        }
        
        .device-status.online {
            color: var(--success-color);
        }
        
        .device-status.offline {
            color: var(--danger-color);
        }
        
        /* Control Panel */
        .control-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .led-card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }
        
        .led-card:hover {
            transform: translateY(-5px);
        }
        
        .led-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .led-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #f5f5f5;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            transition: all 0.3s;
        }
        
        .led-icon.on {
            background: var(--warning-color);
            color: white;
            box-shadow: 0 0 20px var(--warning-color);
        }
        
        .led-title h3 {
            font-size: 20px;
            margin-bottom: 5px;
        }
        
        .led-pin {
            font-size: 14px;
            color: #666;
        }
        
        .led-status-badge {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            display: inline-block;
        }
        
        .badge-on {
            background: #d4edda;
            color: #155724;
        }
        
        .badge-off {
            background: #f8d7da;
            color: #721c24;
        }
        
        .control-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 20px 0;
        }
        
        .btn {
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-primary {
            background: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            background: #1976D2;
        }
        
        .btn-success {
            background: var(--success-color);
            color: white;
        }
        
        .btn-success:hover:not(:disabled) {
            background: #388E3C;
        }
        
        .btn-danger {
            background: var(--danger-color);
            color: white;
        }
        
        .btn-danger:hover:not(:disabled) {
            background: #d32f2f;
        }
        
        .btn-warning {
            background: var(--warning-color);
            color: white;
        }
        
        /* Quick Actions */
        .quick-actions {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        
        .actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .action-btn {
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 16px;
        }
        
        .action-btn:hover:not(:disabled) {
            background: #f5f5f5;
            border-color: var(--primary-color);
        }
        
        /* Log Section */
        .log-section {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        
        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .log-container {
            background: #1e1e1e;
            color: #fff;
            padding: 15px;
            border-radius: 10px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        
        .log-entry {
            padding: 5px;
            border-bottom: 1px solid #333;
        }
        
        .log-time {
            color: #888;
            margin-right: 10px;
        }
        
        .log-info {
            color: #4CAF50;
        }
        
        .log-error {
            color: #f44336;
        }
        
        .log-success {
            color: #2196F3;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .form-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 24px;
            }
            
            .control-panel {
                grid-template-columns: 1fr;
            }
            
            .control-buttons {
                grid-template-columns: 1fr;
            }
            
            .device-selector {
                flex-direction: column;
            }
            
            .device-btn {
                min-width: auto;
            }
        }
        
        /* Loading */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1><i class="fas fa-microchip"></i> IoT LED Control Center</h1>
            <p>ƒêi·ªÅu khi·ªÉn thi·∫øt b·ªã t·ª´ xa qua MQTT - H·ªó tr·ª£ 3G/4G/Wifi</p>
        </div>
        
        <!-- Connection Status -->
        <div class="connection-card">
            <div class="status-grid">
                <div class="status-item" id="mqttStatus">
                    <div class="status-icon">
                        <i class="fas fa-plug"></i>
                    </div>
                    <div class="status-info">
                        <h3>MQTT Connection</h3>
                        <p id="mqttStatusText">ƒêang k·∫øt n·ªëi...</p>
                    </div>
                </div>
                
                <div class="status-item">
                    <div class="status-icon">
                        <i class="fas fa-wifi"></i>
                    </div>
                    <div class="status-info">
                        <h3>Broker</h3>
                        <p id="brokerInfo">broker.emqx.io</p>
                    </div>
                </div>
                
                <div class="status-item">
                    <div class="status-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="status-info">
                        <h3>Last Update</h3>
                        <p id="lastUpdate">--:--:--</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Device Selection -->
        <div class="device-section">
            <h2><i class="fas fa- devices"></i> Ch·ªçn thi·∫øt b·ªã</h2>
            <div class="device-selector" id="deviceSelector">
                <!-- Devices will be added here dynamically -->
            </div>
            <button class="action-btn" onclick="showAddDeviceModal()" style="margin-top: 15px; width: 100%;">
                <i class="fas fa-plus"></i> Th√™m thi·∫øt b·ªã m·ªõi
            </button>
        </div>
        
        <!-- Control Panel -->
        <div class="control-panel" id="controlPanel">
            <!-- LED 1 -->
            <div class="led-card" id="led1Card">
                <div class="led-header">
                    <div class="led-icon" id="led1Icon">
                        <i class="fas fa-lightbulb"></i>
                    </div>
                    <div class="led-title">
                        <h3>LED 1</h3>
                        <p class="led-pin">GPIO 40</p>
                    </div>
                    <div class="led-status-badge" id="led1Badge">T·∫ÆT</div>
                </div>
                
                <div class="control-buttons">
                    <button class="btn btn-success" onclick="controlLED(1, 'on')" id="btnLed1On">
                        <i class="fas fa-power-off"></i> B·∫¨T
                    </button>
                    <button class="btn btn-danger" onclick="controlLED(1, 'off')" id="btnLed1Off">
                        <i class="fas fa-power-off"></i> T·∫ÆT
                    </button>
                    <button class="btn btn-warning" onclick="controlLED(1, 'toggle')" id="btnLed1Toggle">
                        <i class="fas fa-sync"></i> ƒê·∫¢O
                    </button>
                </div>
                
                <div class="signal-strength">
                    <i class="fas fa-signal"></i> T√≠n hi·ªáu: <span id="led1Signal">--</span>
                </div>
            </div>
            
            <!-- LED 2 -->
            <div class="led-card" id="led2Card">
                <div class="led-header">
                    <div class="led-icon" id="led2Icon">
                        <i class="fas fa-lightbulb"></i>
                    </div>
                    <div class="led-title">
                        <h3>LED 2</h3>
                        <p class="led-pin">GPIO 41</p>
                    </div>
                    <div class="led-status-badge" id="led2Badge">T·∫ÆT</div>
                </div>
                
                <div class="control-buttons">
                    <button class="btn btn-success" onclick="controlLED(2, 'on')" id="btnLed2On">
                        <i class="fas fa-power-off"></i> B·∫¨T
                    </button>
                    <button class="btn btn-danger" onclick="controlLED(2, 'off')" id="btnLed2Off">
                        <i class="fas fa-power-off"></i> T·∫ÆT
                    </button>
                    <button class="btn btn-warning" onclick="controlLED(2, 'toggle')" id="btnLed2Toggle">
                        <i class="fas fa-sync"></i> ƒê·∫¢O
                    </button>
                </div>
                
                <div class="signal-strength">
                    <i class="fas fa-signal"></i> T√≠n hi·ªáu: <span id="led2Signal">--</span>
                </div>
            </div>
        </div>
        
        <!-- Quick Actions -->
        <div class="quick-actions">
            <h2><i class="fas fa-bolt"></i> Thao t√°c nhanh</h2>
            <div class="actions-grid">
                <button class="action-btn" onclick="controlAll()" id="btnAllToggle">
                    <i class="fas fa-sync"></i> B·∫≠t/T·∫Øt t·∫•t c·∫£
                </button>
                <button class="action-btn" onclick="getDeviceInfo()">
                    <i class="fas fa-info-circle"></i> Th√¥ng tin thi·∫øt b·ªã
                </button>
                <button class="action-btn" onclick="refreshStatus()">
                    <i class="fas fa-sync-alt"></i> L√†m m·ªõi
                </button>
                <button class="action-btn" onclick="restartDevice()">
                    <i class="fas fa-redo-alt"></i> Kh·ªüi ƒë·ªông l·∫°i
                </button>
            </div>
        </div>
        
        <!-- Log Section -->
        <div class="log-section">
            <div class="log-header">
                <h2><i class="fas fa-history"></i> L·ªãch s·ª≠ ƒëi·ªÅu khi·ªÉn</h2>
                <button class="btn btn-primary" onclick="clearLog()">
                    <i class="fas fa-trash"></i> X√≥a
                </button>
            </div>
            <div class="log-container" id="logContainer">
                <div class="log-entry">
                    <span class="log-time">--:--:--</span>
                    <span class="log-info">S·∫µn s√†ng ƒëi·ªÅu khi·ªÉn</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add Device Modal -->
    <div class="modal" id="addDeviceModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Th√™m thi·∫øt b·ªã m·ªõi</h2>
                <button class="close-btn" onclick="hideAddDeviceModal()">&times;</button>
            </div>
            
            <div class="form-group">
                <label>T√™n thi·∫øt b·ªã</label>
                <input type="text" id="deviceName" placeholder="VD: Ph√≤ng kh√°ch">
            </div>
            
            <div class="form-group">
                <label>Device ID</label>
                <input type="text" id="deviceId" placeholder="VD: ESP32_LED_001">
                <small style="color: #666;">ID duy nh·∫•t cho m·ªói ESP32</small>
            </div>
            
            <div class="form-group">
                <label>MQTT Broker</label>
                <input type="text" id="mqttBroker" value="broker.emqx.io">
            </div>
            
            <div class="form-group">
                <label>Port</label>
                <input type="text" id="mqttPort" value="1883">
            </div>
            
            <button class="btn btn-success" onclick="addNewDevice()" style="width: 100%;">
                <i class="fas fa-plus"></i> Th√™m thi·∫øt b·ªã
            </button>
        </div>
    </div>
    
    <script>
        // C·∫•u h√¨nh MQTT
        const MQTT_CONFIG = {
            broker: 'broker.emqx.io',
            port: 1883,
            protocol: 'ws',  // WebSocket ƒë·ªÉ ch·∫°y tr√™n browser
            clientId: 'web_client_' + Math.random().toString(16).substr(2, 8)
        };
        
        // Bi·∫øn to√†n c·ª•c
        let mqttClient = null;
        let currentDevice = 'ESP32_LED_001';
        let devices = [];
        let ledStates = {
            led1: false,
            led2: false
        };
        let reconnectAttempts = 0;
        const MAX_RECONNECT_ATTEMPTS = 5;
        
        // Load devices from localStorage
        function loadDevices() {
            const saved = localStorage.getItem('iot_devices');
            if (saved) {
                devices = JSON.parse(saved);
            } else {
                // Default device
                devices = [{
                    name: 'ESP32 LED Controller',
                    id: 'ESP32_LED_001',
                    broker: 'broker.emqx.io',
                    port: 1883,
                    online: false
                }];
            }
            updateDeviceSelector();
        }
        
        // Save devices to localStorage
        function saveDevices() {
            localStorage.setItem('iot_devices', JSON.stringify(devices));
        }
        
        // Update device selector UI
        function updateDeviceSelector() {
            const selector = document.getElementById('deviceSelector');
            selector.innerHTML = '';
            
            devices.forEach(device => {
                const btn = document.createElement('button');
                btn.className = `device-btn ${device.id === currentDevice ? 'active' : ''}`;
                btn.onclick = () => selectDevice(device.id);
                
                btn.innerHTML = `
                    <div class="device-name">${device.name}</div>
                    <div class="device-id">${device.id}</div>
                    <div class="device-status ${device.online ? 'online' : 'offline'}">
                        ${device.online ? 'üü¢ Online' : 'üî¥ Offline'}
                    </div>
                `;
                
                selector.appendChild(btn);
            });
        }
        
        // Select device
        function selectDevice(deviceId) {
            currentDevice = deviceId;
            updateDeviceSelector();
            connectMQTT();
            addLog('ƒê√£ chuy·ªÉn sang thi·∫øt b·ªã: ' + deviceId, 'info');
        }
        
        // Show add device modal
        function showAddDeviceModal() {
            document.getElementById('addDeviceModal').classList.add('active');
        }
        
        // Hide add device modal
        function hideAddDeviceModal() {
            document.getElementById('addDeviceModal').classList.remove('active');
        }
        
        // Add new device
        function addNewDevice() {
            const name = document.getElementById('deviceName').value;
            const id = document.getElementById('deviceId').value;
            const broker = document.getElementById('mqttBroker').value;
            const port = document.getElementById('mqttPort').value;
            
            if (!name || !id) {
                alert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin');
                return;
            }
            
            devices.push({
                name: name,
                id: id,
                broker: broker,
                port: parseInt(port),
                online: false
            });
            
            saveDevices();
            updateDeviceSelector();
            hideAddDeviceModal();
            
            // Clear form
            document.getElementById('deviceName').value = '';
            document.getElementById('deviceId').value = '';
            
            addLog('ƒê√£ th√™m thi·∫øt b·ªã: ' + name, 'success');
        }
        
        // K·∫øt n·ªëi MQTT
        function connectMQTT() {
            const device = devices.find(d => d.id === currentDevice);
            if (!device) return;
            
            const mqttUrl = `ws://${device.broker}:${device.port}/mqtt`;
            
            try {
                mqttClient = mqtt.connect(mqttUrl, {
                    clientId: MQTT_CONFIG.clientId,
                    keepalive: 60,
                    clean: true
                });
                
                mqttClient.on('connect', function() {
                    document.getElementById('mqttStatusText').innerHTML = 'üü¢ ƒê√£ k·∫øt n·ªëi';
                    document.getElementById('mqttStatus').className = 'status-item connected';
                    document.getElementById('brokerInfo').innerHTML = device.broker;
                    
                    // Update device online status
                    device.online = true;
                    updateDeviceSelector();
                    
                    addLog('‚úÖ ƒê√£ k·∫øt n·ªëi MQTT th√†nh c√¥ng', 'success');
                    reconnectAttempts = 0;
                    
                    // Subscribe topics
                    const statusTopic = device.id + '/status';
                    const responseTopic = device.id + '/response';
                    
                    mqttClient.subscribe(statusTopic);
                    mqttClient.subscribe(responseTopic);
                    
                    addLog('üì® ƒê√£ subscribe topics', 'info');
                    
                    // Request initial status
                    requestStatus();
                });
                
                mqttClient.on('message', function(topic, message) {
                    handleMQTTMessage(topic, message.toString());
                });
                
                mqttClient.on('error', function(error) {
                    console.error('MQTT Error:', error);
                    addLog('‚ùå L·ªói MQTT: ' + error, 'error');
                });
                
                mqttClient.on('close', function() {
                    document.getElementById('mqttStatusText').innerHTML = 'üî¥ M·∫•t k·∫øt n·ªëi';
                    document.getElementById('mqttStatus').className = 'status-item disconnected';
                    
                    device.online = false;
                    updateDeviceSelector();
                    
                    addLog('üî¥ M·∫•t k·∫øt n·ªëi MQTT', 'error');
                    
                    // Try to reconnect
                    if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
                        reconnectAttempts++;
                        setTimeout(connectMQTT, 5000);
                    }
                });
                
            } catch (error) {
                console.error('Connection error:', error);
                addLog('‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi MQTT', 'error');
            }
        }
        
        // X·ª≠ l√Ω message MQTT
        function handleMQTTMessage(topic, message) {
            try {
                const data = JSON.parse(message);
                const time = new Date().toLocaleTimeString();
                
                addLog(`üì® Nh·∫≠n: ${topic}`, 'info');
                
                // Update status
                if (topic.includes('/status')) {
                    updateLEDStatus(data);
                    
                    // Update signal strength
                    if (data.rssi) {
                        document.getElementById('led1Signal').innerHTML = data.rssi + ' dBm';
                    }
                    
                    // Update uptime
                    if (data.uptime) {
                        const hours = Math.floor(data.uptime / 3600);
                        const minutes = Math.floor((data.uptime % 3600) / 60);
                        document.getElementById('lastUpdate').innerHTML = 
                            `${time} (Uptime: ${hours}h${minutes}m)`;
                    }
                }
                
                // Handle response
                if (topic.includes('/response')) {
                    if (data.success) {
                        addLog(`‚úÖ ${data.message}`, 'success');
                    } else {
                        addLog(`‚ùå ${data.message}`, 'error');
                    }
                }
                
            } catch (e) {
                console.error('Parse error:', e);
                addLog(`üì® Raw: ${topic} - ${message}`, 'info');
            }
        }
        
        // Update LED status on UI
        function updateLEDStatus(data) {
            if (data.led1 !== undefined) {
                ledStates.led1 = data.led1;
                
                // Update LED 1 UI
                const led1Icon = document.getElementById('led1Icon');
                const led1Badge = document.getElementById('led1Badge');
                
                if (data.led1) {
                    led1Icon.classList.add('on');
                    led1Badge.className = 'led-status-badge badge-on';
                    led1Badge.innerHTML = 'B·∫¨T';
                } else {
                    led1Icon.classList.remove('on');
                    led1Badge.className = 'led-status-badge badge-off';
                    led1Badge.innerHTML = 'T·∫ÆT';
                }
            }
            
            if (data.led2 !== undefined) {
                ledStates.led2 = data.led2;
                
                // Update LED 2 UI
                const led2Icon = document.getElementById('led2Icon');
                const led2Badge = document.getElementById('led2Badge');
                
                if (data.led2) {
                    led2Icon.classList.add('on');
                    led2Badge.className = 'led-status-badge badge-on';
                    led2Badge.innerHTML = 'B·∫¨T';
                } else {
                    led2Icon.classList.remove('on');
                    led2Badge.className = 'led-status-badge badge-off';
                    led2Badge.innerHTML = 'T·∫ÆT';
                }
            }
        }
        
        // G·ª≠i l·ªánh ƒëi·ªÅu khi·ªÉn
        function controlLED(led, action) {
            if (!mqttClient || !mqttClient.connected) {
                addLog('‚ùå Ch∆∞a k·∫øt n·ªëi MQTT', 'error');
                return;
            }
            
            const device = devices.find(d => d.id === currentDevice);
            if (!device) return;
            
            const requestId = 'req_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
            
            const command = {
                led: led,
                action: action,
                requestId: requestId,
                timestamp: Date.now()
            };
            
            const topic = device.id + '/control';
            mqttClient.publish(topic, JSON.stringify(command));
            
            const actionText = action === 'on' ? 'B·∫¨T' : (action === 'off' ? 'T·∫ÆT' : 'ƒê·∫¢O');
            addLog(`üì§ ƒê√£ g·ª≠i l·ªánh ${actionText} LED ${led}`, 'info');
            
            // Disable buttons temporarily
            disableButtons(true);
            setTimeout(() => disableButtons(false), 1000);
        }
        
        // ƒêi·ªÅu khi·ªÉn t·∫•t c·∫£ LED
        function controlAll() {
            controlLED(0, 'all_toggle');
        }
        
        // Y√™u c·∫ßu tr·∫°ng th√°i
        function requestStatus() {
            if (!mqttClient || !mqttClient.connected) return;
            
            const device = devices.find(d => d.id === currentDevice);
            if (!device) return;
            
            const command = {
                command: 'get_status',
                requestId: 'req_' + Date.now(),
                timestamp: Date.now()
            };
            
            mqttClient.publish(device.id + '/control', JSON.stringify(command));
            addLog('üì§ Y√™u c·∫ßu c·∫≠p nh·∫≠t tr·∫°ng th√°i', 'info');
        }
        
        // L·∫•y th√¥ng tin thi·∫øt b·ªã
        function getDeviceInfo() {
            if (!mqttClient || !mqttClient.connected) {
                addLog('‚ùå Ch∆∞a k·∫øt n·ªëi MQTT', 'error');
                return;
            }
            
            const device = devices.find(d => d.id === currentDevice);
            if (!device) return;
            
            const command = {
                command: 'get_info',
                requestId: 'req_' + Date.now(),
                timestamp: Date.now()
            };
            
            mqttClient.publish(device.id + '/control', JSON.stringify(command));
            addLog('üì§ Y√™u c·∫ßu th√¥ng tin thi·∫øt b·ªã', 'info');
        }
        
        // Kh·ªüi ƒë·ªông l·∫°i thi·∫øt b·ªã
        function restartDevice() {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën kh·ªüi ƒë·ªông l·∫°i thi·∫øt b·ªã?')) return;
            
            const device = devices.find(d => d.id === currentDevice);
            if (!device) return;
            
            const command = {
                command: 'restart',
                timestamp: Date.now()
            };
            
            mqttClient.publish(device.id + '/command', JSON.stringify(command));
            addLog('üîÑ ƒê√£ g·ª≠i l·ªánh kh·ªüi ƒë·ªông l·∫°i', 'warning');
        }
        
        // L√†m m·ªõi tr·∫°ng th√°i
        function refreshStatus() {
            requestStatus();
        }
        
        // Disable/enable buttons
        function disableButtons(disabled) {
            const buttons = document.querySelectorAll('button');
            buttons.forEach(btn => {
                if (!btn.classList.contains('close-btn')) {
                    btn.disabled = disabled;
                }
            });
        }
        
        // Th√™m log
        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const time = new Date().toLocaleTimeString();
            
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `
                <span class="log-time">[${time}]</span>
                <span class="log-${type}">${message}</span>
            `;
            
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
            
            // Gi·ªõi h·∫°n s·ªë l∆∞·ª£ng log
            if (logContainer.children.length > 100) {
                logContainer.removeChild(logContainer.children[0]);
            }
        }
        
        // X√≥a log
        function clearLog() {
            const logContainer = document.getElementById('logContainer');
            logContainer.innerHTML = '';
            addLog('ƒê√£ x√≥a l·ªãch s·ª≠', 'info');
        }
        
        // Kh·ªüi t·∫°o
        window.onload = function() {
            loadDevices();
            connectMQTT();
            
            // Auto refresh m·ªói 30 gi√¢y
            setInterval(refreshStatus, 30000);
            
            addLog('üöÄ H·ªá th·ªëng ƒë√£ kh·ªüi t·∫°o', 'success');
        };
    </script>
</body>
</html>
