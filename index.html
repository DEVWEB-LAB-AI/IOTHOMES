<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ƒêi·ªÅu khi·ªÉn ESP32-S3</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            margin: 0;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 500px;
            width: 100%;
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 20px;
            font-size: 24px;
        }
        
        .info-box {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #1976D2;
            font-family: monospace;
            font-size: 14px;
        }
        
        .info-box p {
            margin: 8px 0;
            word-break: break-all;
        }
        
        .status-box {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .led {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            margin: 10px auto;
            transition: all 0.3s;
        }
        
        .led-on {
            background: #4CAF50;
            box-shadow: 0 0 30px #4CAF50;
            animation: pulse 1.5s infinite;
        }
        
        .led-off {
            background: #f44336;
            box-shadow: 0 0 30px #f44336;
        }
        
        .led-unknown {
            background: #9e9e9e;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        button {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-on {
            background: #4CAF50;
        }
        
        .btn-off {
            background: #f44336;
        }
        
        button:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .connection-status {
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .connected {
            background: #d4edda;
            color: #155724;
        }
        
        .disconnected {
            background: #f8d7da;
            color: #721c24;
        }
        
        .connecting {
            background: #fff3cd;
            color: #856404;
        }
        
        .debug {
            background: #1e1e1e;
            color: #00ff00;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 20px;
        }
        
        .warning {
            background: #ff9800;
            color: white;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            margin: 10px 0;
            font-weight: bold;
        }
    </style>
    
    <!-- S·ª≠ d·ª•ng MQTT.js thay v√¨ Paho -->
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>üöÄ ƒêI·ªÄU KHI·ªÇN ESP32-S3</h1>
        
        <div class="warning" id="browserWarning" style="display: none;">
            ‚ö†Ô∏è Tr√¨nh duy·ªát c·ªßa b·∫°n c·∫ßn h·ªó tr·ª£ WebSocket
        </div>
        
        <div class="info-box">
            <p><strong>üîó URL:</strong> f70a09e2678a4ee9bd009145291314c2.s1.eu.hivemq.cloud</p>
            <p><strong>üë§ User:</strong> esp32_supermini_control</p>
            <p><strong>üîê Pass:</strong> Esp32@Control2024!</p>
            <p><strong>üì° Port:</strong> 8884 (WebSocket TLS)</p>
        </div>
        
        <div class="status-box">
            <h3>TR·∫†NG TH√ÅI LED</h3>
            <div id="led" class="led led-unknown"></div>
            <p id="statusText" style="font-size: 20px; font-weight: bold;">Ch∆∞a k·∫øt n·ªëi</p>
            <p id="lastUpdate"></p>
        </div>
        
        <div class="btn-group">
            <button id="btnOn" class="btn-on" onclick="sendCommand('ON')" disabled>üî¥ B·∫¨T</button>
            <button id="btnOff" class="btn-off" onclick="sendCommand('OFF')" disabled>‚ö´ T·∫ÆT</button>
        </div>
        
        <div id="connectionStatus" class="connection-status connecting">
            ‚ö° ƒêang k·∫øt n·ªëi HiveMQ Cloud...
        </div>
        
        <button onclick="forceReconnect()" style="width:100%; padding:10px; margin:10px 0; background:#2196F3; color:white; border:none; border-radius:5px; cursor:pointer;">
            üîÑ K·∫æT N·ªêI L·∫†I
        </button>
        
        <div class="debug" id="debug">
            <p>üöÄ ƒêang kh·ªüi t·∫°o...</p>
        </div>
    </div>

    <script>
        // C·∫•u h√¨nh
        const CONFIG = {
            url: "wss://f70a09e2678a4ee9bd009145291314c2.s1.eu.hivemq.cloud:8884/mqtt",
            username: "esp32_supermini_control",
            password: "Esp32@Control2024!"
        };

        let client = null;
        let isConnected = false;
        let reconnectTimeout = null;

        function debug(msg, isError = false) {
            const debugDiv = document.getElementById('debug');
            const p = document.createElement('p');
            const prefix = isError ? '‚ùå' : 'üìå';
            p.textContent = `${prefix} ${new Date().toLocaleTimeString()} - ${msg}`;
            p.style.color = isError ? '#ff6b6b' : '#00ff00';
            debugDiv.appendChild(p);
            while (debugDiv.children.length > 8) {
                debugDiv.removeChild(debugDiv.firstChild);
            }
            console.log(msg);
        }

        function updateConnectionStatus(connected) {
            const statusDiv = document.getElementById('connectionStatus');
            const btnOn = document.getElementById('btnOn');
            const btnOff = document.getElementById('btnOff');
            
            if (connected) {
                statusDiv.className = 'connection-status connected';
                statusDiv.innerHTML = '‚úÖ ƒê√£ k·∫øt n·ªëi HiveMQ Cloud';
                btnOn.disabled = false;
                btnOff.disabled = false;
            } else {
                statusDiv.className = 'connection-status disconnected';
                statusDiv.innerHTML = '‚ùå M·∫•t k·∫øt n·ªëi. ƒêang th·ª≠ l·∫°i...';
                btnOn.disabled = true;
                btnOff.disabled = true;
            }
        }

        function updateLED(state) {
            const led = document.getElementById('led');
            const text = document.getElementById('statusText');
            const update = document.getElementById('lastUpdate');
            
            led.className = 'led ' + (state === 'ON' ? 'led-on' : 'led-off');
            text.innerHTML = state === 'ON' ? 'üî¥ ƒêANG B·∫¨T' : '‚ö´ ƒêANG T·∫ÆT';
            text.style.color = state === 'ON' ? '#4CAF50' : '#f44336';
            update.innerHTML = `üïê C·∫≠p nh·∫≠t: ${new Date().toLocaleTimeString()}`;
        }

        function connectMQTT() {
            if (reconnectTimeout) {
                clearTimeout(reconnectTimeout);
            }

            debug(`üîÑ ƒêang k·∫øt n·ªëi ƒë·∫øn ${CONFIG.url}...`);

            try {
                // Ki·ªÉm tra MQTT.js ƒë√£ load ch∆∞a
                if (typeof mqtt === 'undefined') {
                    debug("‚ùå L·ªói: Th∆∞ vi·ªán MQTT ch∆∞a ƒë∆∞·ª£c load!", true);
                    document.getElementById('browserWarning').style.display = 'block';
                    return;
                }

                // Options k·∫øt n·ªëi
                const options = {
                    clientId: 'web_' + Math.random().toString(36).substring(2, 10),
                    username: CONFIG.username,
                    password: CONFIG.password,
                    clean: true,
                    connectTimeout: 30000,
                    reconnectPeriod: 5000,
                    keepalive: 60
                };

                client = mqtt.connect(CONFIG.url, options);

                client.on('connect', () => {
                    isConnected = true;
                    debug('‚úÖ K·∫æT N·ªêI TH√ÄNH C√îNG!');
                    
                    // Subscribe
                    client.subscribe('esp32/status', (err) => {
                        if (!err) {
                            debug('üì• ƒê√£ subscribe esp32/status');
                        } else {
                            debug('‚ùå L·ªói subscribe: ' + err, true);
                        }
                    });
                    
                    updateConnectionStatus(true);
                    
                    // G·ª≠i STATUS ƒë·ªÉ h·ªèi tr·∫°ng th√°i
                    setTimeout(() => {
                        sendCommand('STATUS');
                    }, 2000);
                });

                client.on('message', (topic, message) => {
                    const payload = message.toString();
                    debug(`üì© Nh·∫≠n: ${payload} t·ª´ ${topic}`);
                    
                    if (payload === 'ON' || payload === 'ONLINE') {
                        updateLED('ON');
                    } else if (payload === 'OFF') {
                        updateLED('OFF');
                    }
                });

                client.on('error', (err) => {
                    isConnected = false;
                    debug(`‚ùå L·ªói: ${err.message}`, true);
                    updateConnectionStatus(false);
                });

                client.on('close', () => {
                    isConnected = false;
                    debug('üîå ƒê√£ ƒë√≥ng k·∫øt n·ªëi');
                    updateConnectionStatus(false);
                });

                client.on('offline', () => {
                    isConnected = false;
                    debug('üì¥ M·∫•t k·∫øt n·ªëi');
                    updateConnectionStatus(false);
                });

            } catch (error) {
                debug(`‚ùå L·ªói: ${error.message}`, true);
                updateConnectionStatus(false);
                
                reconnectTimeout = setTimeout(connectMQTT, 5000);
            }
        }

        function sendCommand(cmd) {
            if (!client || !isConnected) {
                debug('‚ùå Ch∆∞a k·∫øt n·ªëi!', true);
                return;
            }

            debug(`üì§ G·ª≠i: ${cmd}`);
            
            client.publish('esp32/control', cmd, { qos: 1 }, (err) => {
                if (err) {
                    debug(`‚ùå L·ªói g·ª≠i: ${err}`, true);
                } else {
                    debug(`‚úÖ ƒê√£ g·ª≠i ${cmd}`);
                }
            });

            // Visual feedback
            const btn = document.getElementById(cmd === 'ON' ? 'btnOn' : 'btnOff');
            btn.style.transform = 'scale(0.95)';
            setTimeout(() => btn.style.transform = '', 200);
        }

        function forceReconnect() {
            debug('üîÑ ƒêang k·∫øt n·ªëi l·∫°i...');
            if (client) {
                client.end(true);
            }
            setTimeout(connectMQTT, 1000);
        }

        // Ki·ªÉm tra WebSocket support
        if (!window.WebSocket) {
            document.getElementById('browserWarning').style.display = 'block';
            debug('‚ùå Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ WebSocket!', true);
        }

        // B·∫Øt ƒë·∫ßu k·∫øt n·ªëi
        window.onload = () => {
            debug('üöÄ Trang web ƒë√£ t·∫£i');
            debug(`üë§ Username: ${CONFIG.username}`);
            connectMQTT();
        };

        // Cleanup
        window.onbeforeunload = () => {
            if (reconnectTimeout) {
                clearTimeout(reconnectTimeout);
            }
            if (client) {
                client.end(true);
            }
        };
    </script>
</body>
</html>
