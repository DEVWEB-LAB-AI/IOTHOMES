<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ƒêi·ªÅu khi·ªÉn ESP32-S3</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 500px;
            width: 100%;
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 20px;
            font-size: 24px;
        }
        
        .info-box {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #1976D2;
        }
        
        .info-box p {
            margin: 8px 0;
            color: #0d47a1;
            font-family: monospace;
            word-break: break-all;
        }
        
        .status-box {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .led {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            margin: 10px auto;
            transition: all 0.3s;
        }
        
        .led-on {
            background: #4CAF50;
            box-shadow: 0 0 30px #4CAF50;
            animation: pulse 1.5s infinite;
        }
        
        .led-off {
            background: #f44336;
            box-shadow: 0 0 30px #f44336;
        }
        
        .led-unknown {
            background: #9e9e9e;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        button {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-on {
            background: #4CAF50;
        }
        
        .btn-off {
            background: #f44336;
        }
        
        button:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .connection-status {
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .connected {
            background: #d4edda;
            color: #155724;
        }
        
        .disconnected {
            background: #f8d7da;
            color: #721c24;
        }
        
        .connecting {
            background: #fff3cd;
            color: #856404;
        }
        
        .debug {
            background: #1e1e1e;
            color: #00ff00;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 150px;
            overflow-y: auto;
            margin-top: 20px;
        }
        
        .success-badge {
            background: #4CAF50;
            color: white;
            padding: 3px 8px;
            border-radius: 5px;
            font-size: 12px;
            margin-left: 5px;
        }
    </style>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.1.0/paho-mqtt.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>üöÄ ƒêI·ªÄU KHI·ªÇN ESP32-S3 <span class="success-badge">HiveMQ</span></h1>
        
        <div class="info-box">
            <p><strong>üîó Cluster URL:</strong> f70a09e2678a4ee9bd009145291314c2.s1.eu.hivemq.cloud</p>
            <p><strong>üë§ Username:</strong> esp32_supermini_control ‚úÖ</p>
            <p><strong>üîê Password:</strong> Esp32@Control2024!</p>
            <p><strong>üì° Port:</strong> 8884 (WebSocket TLS)</p>
            <p><strong>üìã Topics:</strong> esp32/control, esp32/status</p>
        </div>
        
        <div class="status-box">
            <h3>TR·∫†NG TH√ÅI LED</h3>
            <div id="led" class="led led-unknown"></div>
            <p id="statusText" style="font-size: 20px; font-weight: bold;">Ch∆∞a k·∫øt n·ªëi</p>
            <p id="lastUpdate"></p>
        </div>
        
        <div class="btn-group">
            <button id="btnOn" class="btn-on" onclick="sendCommand('ON')" disabled>üî¥ B·∫¨T</button>
            <button id="btnOff" class="btn-off" onclick="sendCommand('OFF')" disabled>‚ö´ T·∫ÆT</button>
        </div>
        
        <div id="connectionStatus" class="connection-status connecting">
            ‚ö° ƒêang k·∫øt n·ªëi HiveMQ Cloud...
        </div>
        
        <div class="debug" id="debug">
            <p>üöÄ ƒêang kh·ªüi t·∫°o...</p>
        </div>
    </div>

    <script>
        // TH√îNG TIN ƒêƒÇNG NH·∫¨P ƒê√É S·ª¨A
        const CONFIG = {
            url: "f70a09e2678a4ee9bd009145291314c2.s1.eu.hivemq.cloud",
            port: 8884,
            username: "esp32_supermini_control",  // Username m·ªõi h·ª£p l·ªá
            password: "Esp32@Control2024!"
        };
        
        let client;
        let isConnected = false;
        
        function debug(msg) {
            const debugDiv = document.getElementById('debug');
            const p = document.createElement('p');
            p.textContent = `üïí ${new Date().toLocaleTimeString()} - ${msg}`;
            debugDiv.appendChild(p);
            while (debugDiv.children.length > 6) {
                debugDiv.removeChild(debugDiv.firstChild);
            }
        }
        
        function connectMQTT() {
            debug(`üîÑ ƒêang k·∫øt n·ªëi ƒë·∫øn ${CONFIG.url}...`);
            debug(`üë§ Username: ${CONFIG.username}`);
            
            client = new Paho.MQTT.Client(
                CONFIG.url,
                CONFIG.port,
                "web_" + Math.random().toString(36).substring(2, 10)
            );
            
            client.onConnectionLost = (response) => {
                isConnected = false;
                debug(`‚ùå M·∫•t k·∫øt n·ªëi: ${response.errorMessage}`);
                updateConnectionStatus(false);
            };
            
            client.onMessageArrived = (message) => {
                const payload = message.payloadString;
                debug(`üì© Nh·∫≠n: ${payload}`);
                
                if (payload === "ON" || payload === "ONLINE") {
                    updateLED("ON");
                } else if (payload === "OFF") {
                    updateLED("OFF");
                }
            };
            
            client.connect({
                onSuccess: () => {
                    isConnected = true;
                    debug("‚úÖ K·∫øt n·ªëi HiveMQ Cloud th√†nh c√¥ng!");
                    
                    client.subscribe("esp32/status");
                    debug("üì• ƒê√£ subscribe esp32/status");
                    
                    updateConnectionStatus(true);
                    
                    setTimeout(() => {
                        sendCommand("STATUS");
                    }, 1000);
                },
                onFailure: (err) => {
                    isConnected = false;
                    debug(`‚ùå L·ªói: ${err.errorMessage}`);
                    debug("üí° Ki·ªÉm tra:");
                    debug("   - Username: " + CONFIG.username);
                    debug("   - Password: " + CONFIG.password);
                    debug("   - URL: " + CONFIG.url);
                    updateConnectionStatus(false);
                    
                    // Th·ª≠ l·∫°i sau 5 gi√¢y
                    setTimeout(connectMQTT, 5000);
                },
                userName: CONFIG.username,
                password: CONFIG.password,
                useSSL: true,
                keepAliveInterval: 30,
                cleanSession: true,
                reconnect: true
            });
        }
        
        function updateLED(state) {
            const led = document.getElementById('led');
            const text = document.getElementById('statusText');
            const update = document.getElementById('lastUpdate');
            
            led.className = 'led ' + (state === 'ON' ? 'led-on' : 'led-off');
            text.innerHTML = state === 'ON' ? 'ƒêANG B·∫¨T' : 'ƒêANG T·∫ÆT';
            text.style.color = state === 'ON' ? '#4CAF50' : '#f44336';
            update.innerHTML = `üïê C·∫≠p nh·∫≠t: ${new Date().toLocaleTimeString()}`;
        }
        
        function updateConnectionStatus(connected) {
            const statusDiv = document.getElementById('connectionStatus');
            const btnOn = document.getElementById('btnOn');
            const btnOff = document.getElementById('btnOff');
            
            if (connected) {
                statusDiv.className = 'connection-status connected';
                statusDiv.innerHTML = '‚úÖ ƒê√£ k·∫øt n·ªëi HiveMQ Cloud';
                btnOn.disabled = false;
                btnOff.disabled = false;
            } else {
                statusDiv.className = 'connection-status disconnected';
                statusDiv.innerHTML = '‚ùå M·∫•t k·∫øt n·ªëi. ƒêang th·ª≠ l·∫°i...';
                btnOn.disabled = true;
                btnOff.disabled = true;
            }
        }
        
        function sendCommand(cmd) {
            if (!client || !isConnected) {
                alert('‚ùå Ch∆∞a k·∫øt n·ªëi MQTT!');
                return;
            }
            
            debug(`üì§ G·ª≠i l·ªánh: ${cmd}`);
            
            const message = new Paho.MQTT.Message(cmd);
            message.destinationName = "esp32/control";
            message.qos = 1;
            
            client.send(message);
            
            // Hi·ªáu ·ª©ng nh·∫•n n√∫t
            const btn = document.getElementById(cmd === 'ON' ? 'btnOn' : 'btnOff');
            btn.style.transform = 'scale(0.95)';
            setTimeout(() => btn.style.transform = '', 200);
        }
        
        // B·∫Øt ƒë·∫ßu k·∫øt n·ªëi khi load trang
        window.onload = () => {
            debug("üöÄ Trang web ƒë√£ t·∫£i");
            debug("üìù D√πng username: " + CONFIG.username);
            connectMQTT();
        };
    </script>
</body>
</html>
